<%- include('../partials/header', { title: 'Track Complaint - Samyukt' }) %>
<%- include('../partials/navbar') %>

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-6">
            <a href="/user/dashboard" class="inline-flex items-center text-blue-600 hover:text-blue-800 mb-4">
                <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
            </a>
            <h1 class="text-2xl font-bold text-gray-900">Track Your Complaint</h1>
            <p class="text-gray-600 mt-2">Monitor the progress and status of your complaint</p>
        </div>

        <!-- Search Complaint -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Find Your Complaint</h2>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="searchComplaintId" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter Complaint ID (e.g., CMP-001)">
                <button onclick="searchComplaint()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium">
                    <i class="fas fa-search mr-2"></i>Search Complaint
                </button>
            </div>
            <p class="text-sm text-gray-500 mt-2">You can find your Complaint ID in your dashboard or email confirmation</p>
        </div>

        <!-- Complaint Tracking Section -->
        <div id="trackingSection" class="hidden">
            <!-- Complaint Header -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900" id="trackingTitle">Loading...</h2>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" id="trackingStatus">
                                    Loading...
                                </span>
                                <span class="text-sm text-gray-500" id="trackingId">CMP-000</span>
                                <span class="text-sm text-gray-500" id="trackingDate">Loading...</span>
                            </div>
                        </div>
                        <button onclick="shareComplaint()" 
                            class="text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-share-alt mr-1"></i>Share
                        </button>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="px-6 py-4 bg-gray-50">
                    <div class="max-w-2xl mx-auto">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Complaint Progress</span>
                            <span class="text-sm font-medium text-gray-700" id="progressText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Timeline -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Status Timeline</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-8" id="timeline">
                        <!-- Timeline will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Department Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Assigned Department -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Assigned Department</h3>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-building text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900" id="assignedDepartment">Loading...</p>
                                <p class="text-sm text-gray-500" id="departmentContact">Contact information</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estimated Resolution -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Estimated Resolution</h3>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-clock text-green-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900" id="etaDate">Loading...</p>
                                <p class="text-sm text-gray-500" id="etaStatus">Expected completion time</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="viewComplaintDetails()" 
                    class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium">
                    <i class="fas fa-eye mr-2"></i>View Full Details
                </button>
                <button onclick="downloadComplaintReport()" 
                    class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 font-medium">
                    <i class="fas fa-download mr-2"></i>Download Report
                </button>
                <button onclick="requestUpdate()" 
                    class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 font-medium">
                    <i class="fas fa-sync-alt mr-2"></i>Request Update
                </button>
            </div>
        </div>

        <!-- No Complaint Found -->
        <div id="noComplaintFound" class="hidden text-center py-12 bg-white shadow rounded-lg">
            <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Complaint Not Found</h3>
            <p class="text-gray-500 mb-4">Please check the Complaint ID and try again.</p>
            <button onclick="resetSearch()" class="text-blue-600 hover:text-blue-800 font-medium">
                Try Another Complaint ID
            </button>
        </div>

        <!-- Recent Complaints (Quick Access) -->
        <div class="mt-8 bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Your Recent Complaints</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4" id="recentComplaints">
                    <!-- Recent complaints will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Demo complaints data for tracking
    const trackableComplaints = {
        'CMP-001': {
            id: 'CMP-001',
            title: 'Garbage not collected for 3 days',
            category: 'Garbage',
            location: 'RK Puram, Sector 5',
            status: 'pending',
            createdAt: '2024-01-15',
            description: 'Garbage has not been collected from our area for the past 3 days, causing foul smell and health concerns.',
            department: 'Municipal Corporation',
            departmentContact: 'municipal@city.gov.in | 011-23456789',
            timeline: [
                { 
                    status: 'registered', 
                    date: '2024-01-15 10:30', 
                    note: 'Complaint registered successfully',
                    icon: 'fa-clipboard-check',
                    color: 'text-blue-600 bg-blue-100'
                },
                { 
                    status: 'assigned', 
                    date: '2024-01-15 11:00', 
                    note: 'Assigned to Municipal Department',
                    icon: 'fa-building',
                    color: 'text-purple-600 bg-purple-100'
                },
                { 
                    status: 'review', 
                    date: '2024-01-15 14:30', 
                    note: 'Under review by department',
                    icon: 'fa-search',
                    color: 'text-yellow-600 bg-yellow-100'
                }
            ],
            progress: 30
        },
        'CMP-002': {
            id: 'CMP-002',
            title: 'Broken street light',
            category: 'Electricity',
            location: 'MG Road, Block B',
            status: 'in-progress',
            createdAt: '2024-01-14',
            description: 'Street light pole number 45 is broken and leaning dangerously.',
            department: 'Electricity Department',
            departmentContact: 'electricity@city.gov.in | 011-23456790',
            eta: '2024-01-18',
            timeline: [
                { 
                    status: 'registered', 
                    date: '2024-01-14 14:20', 
                    note: 'Complaint registered successfully',
                    icon: 'fa-clipboard-check',
                    color: 'text-blue-600 bg-blue-100'
                },
                { 
                    status: 'assigned', 
                    date: '2024-01-14 15:00', 
                    note: 'Assigned to Electricity Department',
                    icon: 'fa-building',
                    color: 'text-purple-600 bg-purple-100'
                },
                { 
                    status: 'in-progress', 
                    date: '2024-01-15 09:30', 
                    note: 'Inspection team dispatched to location',
                    icon: 'fa-tools',
                    color: 'text-orange-600 bg-orange-100'
                },
                { 
                    status: 'update', 
                    date: '2024-01-15 16:45', 
                    note: 'Repair work scheduled for tomorrow',
                    icon: 'fa-calendar-check',
                    color: 'text-green-600 bg-green-100'
                }
            ],
            progress: 60
        },
        'CMP-003': {
            id: 'CMP-003',
            title: 'Water leakage on main road',
            category: 'Water',
            location: 'Nehru Nagar',
            status: 'resolved',
            createdAt: '2024-01-10',
            resolvedAt: '2024-01-12',
            description: 'Major water pipeline leakage causing water wastage and road damage.',
            department: 'Water Department',
            departmentContact: 'water@city.gov.in | 011-23456791',
            timeline: [
                { 
                    status: 'registered', 
                    date: '2024-01-10 08:45', 
                    note: 'Complaint registered successfully',
                    icon: 'fa-clipboard-check',
                    color: 'text-blue-600 bg-blue-100'
                },
                { 
                    status: 'assigned', 
                    date: '2024-01-10 09:30', 
                    note: 'Assigned to Water Department',
                    icon: 'fa-building',
                    color: 'text-purple-600 bg-purple-100'
                },
                { 
                    status: 'in-progress', 
                    date: '2024-01-11 10:15', 
                    note: 'Repair work started on pipeline',
                    icon: 'fa-tools',
                    color: 'text-orange-600 bg-orange-100'
                },
                { 
                    status: 'resolved', 
                    date: '2024-01-12 16:20', 
                    note: 'Issue resolved successfully. Pipeline repaired and tested.',
                    icon: 'fa-check-circle',
                    color: 'text-green-600 bg-green-100'
                }
            ],
            progress: 100
        }
    };

    function searchComplaint() {
        const complaintId = document.getElementById('searchComplaintId').value.trim().toUpperCase();
        const trackingSection = document.getElementById('trackingSection');
        const noComplaintFound = document.getElementById('noComplaintFound');

        if (!complaintId) {
            alert('Please enter a Complaint ID');
            return;
        }

        const complaint = trackableComplaints[complaintId];

        if (complaint) {
            displayComplaintTracking(complaint);
            trackingSection.classList.remove('hidden');
            noComplaintFound.classList.add('hidden');
        } else {
            trackingSection.classList.add('hidden');
            noComplaintFound.classList.remove('hidden');
        }
    }

    function displayComplaintTracking(complaint) {
        // Update basic info
        document.getElementById('trackingTitle').textContent = complaint.title;
        document.getElementById('trackingId').textContent = complaint.id;
        document.getElementById('trackingDate').textContent = `Created: ${formatDate(complaint.createdAt)}`;
        
        // Update status
        const statusElement = document.getElementById('trackingStatus');
        statusElement.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(complaint.status)}`;
        statusElement.textContent = getStatusText(complaint.status);

        // Update progress
        document.getElementById('progressText').textContent = `${complaint.progress}% Complete`;
        document.getElementById('progressBar').style.width = `${complaint.progress}%`;

        // Update department info
        document.getElementById('assignedDepartment').textContent = complaint.department;
        document.getElementById('departmentContact').textContent = complaint.departmentContact;

        // Update ETA
        const etaDate = document.getElementById('etaDate');
        const etaStatus = document.getElementById('etaStatus');
        if (complaint.eta) {
            etaDate.textContent = formatDate(complaint.eta);
            etaStatus.textContent = 'Expected completion date';
        } else if (complaint.status === 'resolved') {
            etaDate.textContent = 'Completed';
            etaStatus.textContent = `Resolved on ${formatDate(complaint.resolvedAt)}`;
        } else {
            etaDate.textContent = 'To be determined';
            etaStatus.textContent = 'Department will provide ETA soon';
        }

        // Update timeline
        updateTimeline(complaint.timeline);
    }

    function updateTimeline(timeline) {
        const timelineElement = document.getElementById('timeline');
        
        timelineElement.innerHTML = timeline.map((item, index) => `
            <div class="flex">
                <div class="flex flex-col items-center mr-4">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${item.color}">
                        <i class="fas ${item.icon}"></i>
                    </div>
                    ${index < timeline.length - 1 ? '<div class="w-0.5 h-8 bg-gray-300 mt-2"></div>' : ''}
                </div>
                <div class="flex-1 pb-6">
                    <p class="text-sm font-medium text-gray-900">${getTimelineStatusText(item.status)}</p>
                    <p class="text-xs text-gray-500">${formatDateTime(item.date)}</p>
                    ${item.note ? `<p class="text-sm text-gray-600 mt-1">${item.note}</p>` : ''}
                </div>
            </div>
        `).join('');
    }

    function getTimelineStatusText(status) {
        const texts = {
            'registered': 'Complaint Registered',
            'assigned': 'Assigned to Department',
            'review': 'Under Review',
            'in-progress': 'Work In Progress',
            'update': 'Status Update',
            'resolved': 'Issue Resolved'
        };
        return texts[status] || status;
    }

    function getStatusClass(status) {
        const classes = {
            'pending': 'bg-yellow-100 text-yellow-800',
            'in-progress': 'bg-blue-100 text-blue-800',
            'resolved': 'bg-green-100 text-green-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusText(status) {
        const texts = {
            'pending': 'Pending',
            'in-progress': 'In Progress',
            'resolved': 'Resolved'
        };
        return texts[status] || status;
    }

    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('en-IN', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    function formatDateTime(dateTimeString) {
        return new Date(dateTimeString).toLocaleString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function viewComplaintDetails() {
        const complaintId = document.getElementById('trackingId').textContent;
        localStorage.setItem('currentComplaintId', complaintId);
        window.location.href = '/user/complaint-details';
    }

    function downloadComplaintReport() {
        const complaintId = document.getElementById('trackingId').textContent;
        alert(`Downloading report for ${complaintId}`);
        // In real app, this would generate and download a PDF report
    }

    function requestUpdate() {
        const complaintId = document.getElementById('trackingId').textContent;
        alert(`Update request sent for ${complaintId}. Department will respond within 24 hours.`);
    }

    function shareComplaint() {
        const complaintId = document.getElementById('trackingId').textContent;
        const complaintTitle = document.getElementById('trackingTitle').textContent;
        
        const shareText = `Track my complaint on Samyukt:\nComplaint ID: ${complaintId}\nIssue: ${complaintTitle}\n\nView status: ${window.location.href}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Samyukt Complaint Tracking',
                text: shareText,
                url: window.location.href
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Complaint tracking link copied to clipboard!');
            });
        }
    }

    function resetSearch() {
        document.getElementById('searchComplaintId').value = '';
        document.getElementById('trackingSection').classList.add('hidden');
        document.getElementById('noComplaintFound').classList.add('hidden');
    }

    function loadRecentComplaints() {
        const recentContainer = document.getElementById('recentComplaints');
        
        const recentComplaints = Object.values(trackableComplaints).slice(0, 3);
        
        recentContainer.innerHTML = recentComplaints.map(complaint => `
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                 onclick="document.getElementById('searchComplaintId').value='${complaint.id}'; searchComplaint();">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${getStatusClass(complaint.status)}">
                        <i class="fas ${complaint.status === 'resolved' ? 'fa-check' : 'fa-clock'} text-xs"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900">${complaint.title}</p>
                        <p class="text-sm text-gray-500">${complaint.id} â€¢ ${formatDate(complaint.createdAt)}</p>
                    </div>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(complaint.status)}">
                    ${getStatusText(complaint.status)}
                </span>
            </div>
        `).join('');
    }

    // Auto-load complaint if ID is in URL or localStorage
    document.addEventListener('DOMContentLoaded', function() {
        loadRecentComplaints();
        
        // Check if complaint ID is passed from dashboard
        const urlParams = new URLSearchParams(window.location.search);
        const complaintId = urlParams.get('id') || localStorage.getItem('currentComplaintId');
        
        if (complaintId) {
            document.getElementById('searchComplaintId').value = complaintId;
            searchComplaint();
        }
    });
</script>

<%- include('../partials/footer') %>